---
title: "ms and AliSim Sequence Simulation"
---

```{r simsetup, include=FALSE}
write.table(c("",
              "####################################",
              "####  ms and AliSim Simulation  ####",
              "####################################"),
            file=fn_log, quote=F, row.names=F, col.names=F, append=T)

# create simulation dir
simulation_outdir <- paste(getwd(), "/simulation", sep="")
if (!dir.exists(simulation_outdir)) {
  dir.create(simulation_outdir, recursive = T)
}

# input/output filenames
fn_msfile <- paste(simulation_outdir, "/", params$prefix, ".ms", sep="")
fn_mstrees <- paste(simulation_outdir, "/", params$prefix, ".mstrees", sep="")
fn_mttrees <- paste(simulation_outdir, "/", params$prefix, ".multitree", sep="")
fn_mstops <- paste(simulation_outdir, "/", params$prefix, ".mstops", sep="")
fn_uqtops <- paste(simulation_outdir, "/", params$prefix, ".uqtops", sep="")

fn_nexus <- paste(simulation_outdir, "/", params$prefix, ".nex", sep="")
fn_alisim <- paste(simulation_outdir, "/", params$prefix, sep="")
```

```{r ms, include=FALSE}
options(scipen=999)
ms_command <- paste(params$ms_params, "-r", params$ms_r, params$ms_l)

# generate seedms
if (file.exists("seedms") && !params$redo) {
  log4r::info(fn_logger, "File already exists: seedms. Skipped.")
} else {
  randseed <- paste(sample(10000:99999,3), collapse=" ")
  write.table(randseed, file="seedms", quote=F, row.names=F, col.names=F)
  log4r::info(fn_logger, "File created: seedms.")
}

# generate msfile
if (file.exists(fn_msfile) && !params$redo) {
  log4r::info(fn_logger, "File already exists: msfile. Skipped.")
} else {
  system(paste(params$msdir,ms_command,">",fn_msfile))
  log4r::info(fn_logger, paste0("File created: ", params$prefix, ".ms.", sep=""))
}
```

```{r postms, include=FALSE}
options(scipen=999)

if (all(file.exists(fn_mstrees, fn_mttrees, fn_mstops, fn_uqtops)) && !params$redo) {
  log4r::info(fn_logger, "Files already exist: ms summary files. Skipped.")
  
} else {
  ms <- read.delim(fn_msfile)
  mstrees <- subset(ms, grepl("^\\[", ms[,1]))
  
  # extract ms trees
  if (nrow(mstrees) == 0) {
    onlytree <- subset(ms, grepl("^\\(.+\\);$", ms[,1]))
    mstrees <- data.frame(paste("[",params$ms_l,"]",onlytree,sep=""))
  }
  
  # convert ms trees into dataframe
  trees <- data.frame(do.call('rbind', strsplit(as.character(mstrees[,1]), '\\[|\\]')))
  trees[,1] <- NULL
  colnames(trees) <- c("length","tree")
  trees$length <- as.numeric(trees$length)
  
  # combine contiguous trees together  
  summary <- trees %>%
    group_by(tree, group_run = data.table::rleid(tree)) %>%
    summarise_all(sum) %>%
    arrange(group_run)
  summary$group_run <- NULL
    
  n <- nrow(summary)
  start <- c(1)
  stop <- c(summary$length[1])
  
  # store first tree without branch lengths  
  first_tree <- read.tree(text=summary$tree[1])
  first_tree$edge.length <- NULL
  topology <- c(write.tree(first_tree))
    
  if (n > 1) {
    for (i in 2:n){
      start <- c(start,stop[length(stop)]+1)
      stop <- c(stop,stop[length(stop)]+summary$length[i])
        
      # store trees without branch lengths
      temp_tree <- read.tree(text=summary$tree[i])
      temp_tree$edge.length <- NULL
      topology <- c(topology,write.tree(temp_tree))
    }
  }
    
  summary <- cbind(summary,start=start,stop=stop,topology=topology)
  write.table(summary, fn_mstrees, sep="\t", quote=F, row.names=F)
  write.table(summary$tree, file=fn_mttrees, sep="\t", quote=F, row.names=F, col.names=F)
  log4r::info(fn_logger, paste0(n, " tree partition(s) found. Files created: ",
                               params$prefix, ".mstrees and ", params$prefix, ".multitree", sep=""))
    
  # combine contiguous topologies together
  t_summary <- summary %>%
    group_by(topology, group_run = data.table::rleid(topology)) %>%
    summarise(length=sum(length)) %>%
    arrange(group_run)
  t_summary$group_run <- NULL
    
  nt <- nrow(t_summary)
  start <- c(1)
  stop <- c(t_summary$length[1])

  if (nt > 1) {
    for (i in 2:nt){
      start <- c(start,stop[length(stop)]+1)
      stop <- c(stop,stop[length(stop)]+t_summary$length[i])
    }
  }    
  
  t_summary <- cbind(t_summary,start=start,stop=stop)
  write.table(t_summary, file=fn_mstops, sep="\t", quote=F, row.names=F)
  write.table(data.frame(unique(t_summary$topology)), file=fn_uqtops, sep="\t", quote=F, row.names=F, col.names=F)
  log4r::info(fn_logger, paste0(nt, " topology partition(s) found. Files created: ", 
                               params$prefix, ".mstops and ", params$prefix, ".uqtops", sep=""))
}
```

```{r prealisim, include=FALSE}
if (file.exists(fn_nexus) && !params$redo) {
  log4r::info(fn_logger, "File already exists: AliSim nexus file. Skipped.")
  
} else {
  mstrees <- read.table(fn_mstrees)
  colnames(mstrees) <- mstrees[1,]
  mstrees <- mstrees[-1,]
  
  # generating nexus file
  res <- lapply(1:nrow(mstrees), function(i) {
    paste("    charset gene_",i," = DNA, ",mstrees$start[i],"-",mstrees$stop[i],";",sep="")
  })
  
  nexus_lines <- c("#nexus", "begin sets;", unlist(res), "end;")
  
  fileConn<-file(fn_nexus)
  writeLines(nexus_lines, fileConn)
  close(fileConn)
  
  log4r::info(fn_logger, paste0("File created: ", params$prefix, ".nex.", sep=""))
}
```

```{r alisim, include=FALSE}
if (file.exists(paste(fn_alisim, ".fa", sep = "")) && !params$redo) {
  log4r::info(fn_logger, "File already exists: AliSim alignment file. Skipped.")
  
} else {
  if (params$alisim_scale == 0 || is.null(params$alisim_scale)) {
    system(paste(params$iqtree2dir,
                 "--alisim",fn_alisim,
                 "-Q",fn_nexus,
                 "-t",fn_mttrees,
                 "-m",params$alisim_model,
                 "-nt",params$threads,
                 "-af fasta -redo", sep=" "))
  } else {
    system(paste(params$iqtree2dir,
                 "--alisim",fn_alisim,
                 "-Q",fn_nexus,
                 "-t",fn_mttrees,
                 "--branch-scale",params$alisim_scale,
                 "-m",params$alisim_model,
                 "-nt",params$threads,
                 "-af fasta -redo", sep=" "))
  }
  
  log4r::info(fn_logger, paste0("File created: ", params$prefix, ".fa.", sep=""))
}
```