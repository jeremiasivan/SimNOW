---
title: "Sequence Simulation"
---

```{r simsetup, include=FALSE}
write.table(c("",
              "####################################",
              "####     Sequence Simulation    ####",
              "####################################"),
            file=fn_log, quote=F, row.names=F, col.names=F, append=T)

# create simulation dir
simulation_outdir <- paste0(getwd(), "/simulation")
if (!dir.exists(simulation_outdir)) {
  dir.create(simulation_outdir, recursive = T)
}

# input/output files
fn_msfile <- paste0(simulation_outdir, "/", params$prefix, ".ms")
fn_mstrees <- paste0(simulation_outdir, "/", params$prefix, ".mstrees")
fn_mttrees <- paste0(simulation_outdir, "/", params$prefix, ".multitree")
fn_mstops <- paste0(simulation_outdir, "/", params$prefix, ".mstops")
fn_uqtops <- paste0(simulation_outdir, "/", params$prefix, ".uqtops")

fn_nexus <- paste0(simulation_outdir, "/", params$prefix, ".nex")
fn_alisim <- paste0(simulation_outdir, "/", params$prefix)
fn_alisim_fa <- paste0(simulation_outdir, "/", params$prefix, ".fa")

alisim_treedir <- paste0(simulation_outdir, "/tree/")
fn_alisim_tree <- paste0(alisim_treedir, params$prefix)
if (!dir.exists(alisim_treedir)) {
  dir.create(alisim_treedir, recursive = T)
}
```

```{r ms, include=FALSE}
write.table(c("",
              "---------------- ms ----------------"),
              file=fn_log, quote=F, row.names=F, col.names=F, append=T)

options(scipen=999)
randseed <- paste(sample(10000:99999,3), collapse=" ")
ms_command <- paste(params$ms_params, "-r", params$ms_r, params$ms_l, "-seeds", randseed)

# generate msfile
if (file.exists(fn_msfile) && !params$redo) {
  log4r::info(fn_logger, paste0("File found: ", params$prefix, "ms."))
} else {
  system(paste(params$msdir,ms_command,">",fn_msfile))
  log4r::info(fn_logger, paste0("File created: ", params$prefix, ".ms."))
}
```

```{r postms, include=FALSE}
options(scipen=999)

if (all(file.exists(fn_mstrees, fn_mttrees, fn_mstops, fn_uqtops)) && !params$redo) {
  log4r::info(fn_logger, "File found: ms summary files.")
  
} else {
  ms <- data.table::fread(fn_msfile, col.names="cmd", sep="")
  
  # extract ms trees
  mstrees <- ms[grepl("^\\[", cmd)]
  if (nrow(mstrees) == 0) {
    mstrees <- ms[grepl("^\\(.+\\);$", cmd)]
    mstrees[1, cmd := paste0("[", params$ms_l, "]", mstrees[1, cmd])]
  }
  
  # convert ms trees into data.table
  mstrees[, c("empty","length","tree") := data.table::tstrsplit(cmd, '\\[|\\]', fixed = FALSE)]
  mstrees[, c("cmd", "empty") := NULL]
  mstrees$length <- as.numeric(mstrees$length)
  
  # combine contiguous trees together  
  summary <- mstrees %>%
    group_by(tree, group_run = data.table::rleid(tree)) %>%
    summarise_all(sum) %>%
    arrange(group_run)
  summary$group_run <- NULL
  summary <- data.table::as.data.table(summary)
    
  # store first tree without branch lengths  
  n <- nrow(summary)
  start <- 1
  stop <- summary$length[1]
  
  first_tree <- ape::read.tree(text=summary$tree[1])
  first_tree$edge.length <- NULL
  topology <- ape::write.tree(first_tree)
    
  # store subsequent trees without branch lengths
  if (n > 1) {
    for (i in 2:n){
      start <- c(start,stop[length(stop)]+1)
      stop <- c(stop,stop[length(stop)]+summary$length[i])

      temp_tree <- ape::read.tree(text=summary$tree[i])
      temp_tree$edge.length <- NULL
      topology <- c(topology, ape::write.tree(temp_tree))
    }
  }
    
  summary[, c("start", "stop", "topology") := list(start, stop, topology)]
  data.table::fwrite(summary, file=fn_mstrees, sep="\t", quote=F)
  write.table(summary$tree, file=fn_mttrees, sep="\t", quote=F, row.names=F, col.names=F)
  log4r::info(fn_logger, paste0(n, " tree partition(s) found. File created: ",
                               params$prefix, ".mstrees and ", params$prefix, ".multitree"))
    
  # combine contiguous topologies together (pt.1)
  t_summary <- summary %>%
    group_by(topology, group_run = data.table::rleid(topology)) %>%
    summarise(length=sum(length)) %>%
    arrange(group_run)
  t_summary$group_run <- NULL
  t_summary <- as.data.table(t_summary)
  
  # extract unique topologies
  all_tops <- t_summary$topology
  len_tops <- length(all_tops)
  
  ls_unroot <- all_tops[1]
  ls_uqtops <- all_tops[1]
  
  if (len_tops > 1) {
    for (i in all_tops[2:len_tops]) {
      is_equal <- FALSE
      
      for (j in ls_unroot) {
        if (ape::all.equal.phylo(ape::unroot(ape::read.tree(text = i)), ape::unroot(ape::read.tree(text = j)))) {
          is_equal <- TRUE
          ls_uqtops <- c(ls_uqtops, j)
          break
        }
      }
      
      if (!is_equal) {
        ls_unroot <- c(ls_unroot, i)
        ls_uqtops <- c(ls_uqtops, i)
      }
    }
  }
  
  t_summary[, "utopology" := ls_uqtops]
  
  # combine contiguous topologies together (pt.2)
  t_summary <- t_summary %>%
    group_by(utopology, group_run = data.table::rleid(topology)) %>%
    summarise(length=sum(length)) %>%
    arrange(group_run)
  t_summary$group_run <- NULL
  t_summary <- as.data.table(t_summary)
  data.table::setnames(t_summary, c("topology", "length"))
   
  # store the boundary of each topology 
  nt <- nrow(t_summary)
  start <- 1
  stop <- t_summary$length[1]

  if (nt > 1) {
    for (i in 2:nt){
      start <- c(start,stop[length(stop)]+1)
      stop <- c(stop,stop[length(stop)]+t_summary$length[i])
    }
  }    
  
  t_summary[, c("start", "stop") := list(start, stop)]
  data.table::fwrite(t_summary, file=fn_mstops, sep="\t", quote=F)
  write.table(unique(t_summary$topology), file=fn_uqtops, sep="\t", quote=F, row.names=F, col.names=F)
  log4r::info(fn_logger, paste0(nt, " topology partition(s) found. File created: ", 
                               params$prefix, ".mstops and ", params$prefix, ".uqtops"))
  
  rm(ms, mstrees, summary, t_summary, start, stop, topology)
}
```

```{r prealisim, include=FALSE}
write.table(c("",
              "-------------- AliSim --------------"),
              file=fn_log, quote=F, row.names=F, col.names=F, append=T)

if (file.exists(fn_nexus) && !params$redo) {
  log4r::info(fn_logger, paste0("File found: ", params$prefix, ".nex."))
  
} else {
  mstrees <- data.table::fread(fn_mstrees)
  
  # generate nexus file
  res <- lapply(1:nrow(mstrees), function(i) {
    paste0("    charset gene_",i," = DNA, ",mstrees$start[i],"-",mstrees$stop[i],";")
  })
  
  nexus_lines <- c("#nexus", "begin sets;", unlist(res), "end;")
  
  fileConn <- file(fn_nexus)
  writeLines(nexus_lines, fileConn)
  close(fileConn)
  
  log4r::info(fn_logger, paste0("File created: ", params$prefix, ".nex."))
  rm(mstrees, res)
}
```

```{r alisim, include=FALSE}
if (file.exists(paste0(fn_alisim, ".fa")) && !params$redo) {
  log4r::info(fn_logger, paste0("File found: ", params$prefix, ".fa."))
  
} else {
  if (params$alisim_scale == 0 || is.null(params$alisim_scale)) {
    system(paste(params$iqtree2dir,
                 "--alisim",fn_alisim,
                 "-Q",fn_nexus,
                 "-t",fn_mttrees,
                 "-m",params$alisim_model,
                 "-T",params$thread,
                 "-af fasta -redo"))
  } else {
    system(paste(params$iqtree2dir,
                 "--alisim",fn_alisim,
                 "-Q",fn_nexus,
                 "-t",fn_mttrees,
                 "--branch-scale",params$alisim_scale,
                 "-m",params$alisim_model,
                 "-T",params$thread,
                 "-af fasta -redo"))
  }
  
  # generate tree based on concatenated alignment
  system(paste(params$iqtree2dir,
               "-s",fn_alisim_fa,
               "-m",params$alisim_model,
               "-pre",fn_alisim_tree,
               "-T 1 --quiet -redo"))
  
  log4r::info(fn_logger, paste0("File created: ", params$prefix, ".fa."))
}
```