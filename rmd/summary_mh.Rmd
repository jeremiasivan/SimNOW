---
title: "Summary of MAST-HMM Analyses"
params:
  prefix: ""
  outdir: ""
  redo: TRUE
---

```{r library, include=FALSE}
library(dplyr)
library(data.table)
library(ggplot2)
library(RColorBrewer)
```

```{r setup, include=FALSE}
fn_figs <- c()
pcolors <- RColorBrewer::brewer.pal(8, "Dark2")

fn_hmmacc <- paste(params$outdir, "/", params$prefix, ".hmmacc", sep="")
fn_hmmtopset <- paste(params$outdir, "/", params$prefix, ".hmmtopset", sep="")
fn_hmmfig <- paste(params$outdir, "/", params$prefix, ".hmmacc.tiff", sep="")
fn_hmmwacc <- paste(params$outdir, "/", params$prefix, ".hmmwacc", sep="")
fn_hmmwfig <- paste(params$outdir, "/", params$prefix, ".hmmwacc.tiff", sep="")
if (all(file.exists(fn_hmmacc, fn_hmmtopset, fn_hmmfig, fn_hmmwacc, fn_hmmwfig)) && params$redo == FALSE) {
  print("MAST-HMM summary files already exist. Stopping...")
  knitr::knit_exit()
}

# retrieve all simulations
allsims <- list.dirs(params$outdir, full.names = F, recursive = F)
simulation <- allsims[grep(paste("^",params$prefix,"_",sep=""), allsims)]

# retrieve all MAST models
top_sets <- list.dirs(paste(params$outdir, "/", simulation[1], "/masthmm/", sep=""), full.names = F, recursive = F)
model_list <- list.dirs(paste(params$outdir, "/", simulation[1], "/masthmm/", top_sets[1], "/", sep=""), full.names = F, recursive = F)
model_list <- subset(model_list, model_list != paste(simulation[1], ".mast.tops", sep=""))
```

```{r hmmtruthwindow, include=FALSE}
dfsets <- data.frame("wsize", "set", "simulation", "r")

# retrieve topology set and recombination rate for each simulation
for (s in simulation) {
  dftmp <- read.table(paste(params$outdir, "/", s, "/masthmm/", s, ".topset", sep=""))
  colnames(dftmp) <- dftmp[1,]
  dftmp <- dftmp[-1,]
  
  fn_ms <- paste(params$outdir, "/", s, "/simulation/", s, ".ms", sep="")
  command <- strsplit(system(paste("grep 'ms'", fn_ms), intern=T), " ")
  
  for (r in 1:nrow(dftmp)) {
    dfsets <- rbind(dfsets, c(dftmp$wsizes[r], as.numeric(rownames(dftmp)[r])-1, s, command[[1]][length(command[[1]])-1]))
  }
}

colnames(dfsets) <- dfsets[1,]
dfsets <- dfsets[-1,]

# calculate MAST-HMM accuracy for each window size
dfviz <- data.frame("dir","accuracy","model","r","wsize")

for (e in 1:nrow(dfsets)) {
  wstmp <- strsplit(dfsets$wsize[e],"_")[[1]]
  mhtmp <- paste(params$outdir, "/", dfsets$simulation[e], "/masthmm/", dfsets$set[e], "/", sep="")
    
  for (m in model_list) {
    fn_hmmsum <- paste(mhtmp, m, "/", dfsets$simulation[e], ".hmmsum", sep="")
    if (!file.exists(fn_hmmsum)) {
      next
    }
      
    hmmsum <- read.table(fn_hmmsum)
    hmmsum <- sapply(hmmsum[-1,-1], as.numeric)
    
    # calculate the accuracy with if conditional for one topology  
    acc <- 0
    if (is.null(nrow(hmmsum))) {
      acc <- hmmsum[1]
    } else {
      for (k in 1:nrow(hmmsum)) {
        acc <- acc + as.numeric(hmmsum[k,k])
      }
    }
    acc <- round(acc / sum(hmmsum) * 100, 3)
    
    # store the values in dataframe
    for (w in wstmp) {
      dfviz <- rbind(dfviz, c(fn_hmmsum, acc, m, dfsets$r[e], w))
    }
  }
}

colnames(dfviz) <- dfviz[1,]
dfviz <- dfviz[-1,]

dfviz$model <- gsub("\\_","+",toupper(dfviz$model))
dfviz$wsize <- factor(as.numeric(dfviz$wsize)/1000)

write.table(dfviz, fn_hmmwacc, quote = F, row.names = F, col.names = T)

# visualization for all simulations
tiff(filename=fn_hmmwfig, units="px", width=2880, height=1800)
print(ggplot(dfviz, aes(y=as.numeric(accuracy), x=wsize, ymin=0, ymax=100)) + 
        geom_jitter(shape=16, width = 0.1, height = 0, aes(colour=r), size=5) +
        scale_colour_manual(values = pcolors) +
        ggtitle("Accuracy of Non-Overlapping Windows in Simulated Dataset") + 
        xlab("Window size (kb)") +
        ylab("Accuracy (%)") +
        theme(
          plot.title = element_text(hjust = 0.5, size = 50),
          plot.margin = margin(0, 0, 1.25, 0, "cm"),
          axis.title.x=element_text(size = 40, margin = margin(t=20, r=0, b=0, l=0)),
          axis.title.y=element_text(size = 40, margin = margin(t=0, r=20, b=0, l=0)),
          axis.text.y=element_text(size=30),
          axis.text.x=element_text(size=30),
          legend.title=element_text(size=30),
          legend.text=element_text(size=30),
          legend.key.size=unit(2,"cm")
        ))
dev.off()

# visualization for simulations per recombination rate
fn_figs <- c(fn_figs, fn_hmmwfig)
iterator <- 0

for (i in unique(dfviz$r)) {
  outperr <- subset(dfviz, dfviz$r == i)
  
  fn_simfig <- paste(params$outdir, "/", params$prefix, ".hmmwacc.r",i,".tiff", sep="")
  fn_figs <- c(fn_figs, fn_simfig)
  iterator <- iterator + 1
  
  tiff(filename=fn_simfig, units="px", width=2880, height=1800)
  print(ggplot(outperr, aes(y=as.numeric(accuracy), x=wsize, ymin=0, ymax=100)) + 
          geom_boxplot() +
          geom_jitter(shape=16, width = 0.1, height = 0, aes(colour=r), size=5) +
          scale_colour_manual(values = pcolors[iterator]) +
          ggtitle("Accuracy of Non-Overlapping Windows in Simulated Dataset") + 
          xlab("Window size (kb)") +
          ylab("Accuracy (%)") +
          theme(
            plot.title = element_text(hjust = 0.5, size = 50),
            plot.margin = margin(1.25, 0, 1.25, 0, "cm"),
            axis.title.x=element_text(size = 40, margin = margin(t=20, r=0, b=0, l=0)),
            axis.title.y=element_text(size = 40, margin = margin(t=0, r=20, b=0, l=0)),
            axis.text.y=element_text(size=30),
            axis.text.x=element_text(size=30),
            legend.title=element_text(size=30),
            legend.text=element_text(size=30),
            legend.key.size=unit(2,"cm")
          ))
  dev.off()
}
```

```{r hmmtruthset, eval=FALSE, include=FALSE}
dfsets <- data.frame("topologies", "set", "simulation", "r")

# retrieve topology set and recombination rate for each simulation
for (s in simulation) {
  dftmp <- read.table(paste(params$outdir, "/", s, "/masthmm/", s, ".topset", sep=""))
  colnames(dftmp) <- dftmp[1,]
  dftmp <- dftmp[-1,]
  
  fn_ms <- paste(params$outdir, "/", s, "/simulation/", s, ".ms", sep="")
  command <- strsplit(system(paste("grep 'ms'", fn_ms), intern=T), " ")
  
  for (r in 1:nrow(dftmp)) {
    dfsets <- rbind(dfsets, c(dftmp$topologies[r], as.numeric(rownames(dftmp)[r])-1, s, command[[1]][length(command[[1]])-1]))
  }
}

colnames(dfsets) <- dfsets[1,]
dfsets <- dfsets[-1,]

# calculate MAST-HMM accuracy for each topology set
dfviz <- data.frame("accuracy","model","r","set")
dfstop <- data.frame("set","topology")
set_iterator <- 1

for (t in unique(dfsets$topologies)) {
  dfsubs <- subset(dfsets[dfsets$topologies == t,])
  
  for (r in 1:nrow(dfsubs)) {
    mhtemp <- paste(params$outdir, "/", dfsubs$simulation[r], "/masthmm/", dfsubs$set[r], "/", sep="")
    
    for (m in model_list) {
      fn_hmmsum <- paste(mhtemp, m, "/", dfsubs$simulation[r], ".hmmsum", sep="")
      if (!file.exists(fn_hmmsum)) {
        next
      }
      
      hmmsum <- read.table(fn_hmmsum)
      hmmsum <- sapply(hmmsum[-1,-1], as.numeric)
      
      # calculate the accuracy with if conditional for one topology  
      acc <- 0
      if (is.null(nrow(hmmsum))) {
        acc <- hmmsum[1]
      } else {
        for (k in 1:nrow(hmmsum)) {
          acc <- acc + as.numeric(hmmsum[k,k])
        }
      }
      acc <- round(acc / sum(hmmsum) * 100, 3)
      
      # store the values in dataframe
      dfviz <- rbind(dfviz, c(acc, m, dfsubs$r[r], set_iterator))
    }
  }
  
  dfstop <- rbind(dfstop, c(set_iterator,t))
  set_iterator <- set_iterator + 1
}

colnames(dfstop) <- dfstop[1,]
dfstop <- dfstop[-1,]

colnames(dfviz) <- dfviz[1,]
dfviz <- dfviz[-1,]

dfviz$model <- gsub("\\_","+",toupper(dfviz$model))
dfviz$set <- factor(dfviz$set,levels = unique(dfviz$set),ordered = T)

write.table(dfstop, fn_hmmtopset, quote = F, row.names = F, col.names = T)
write.table(dfviz, fn_hmmacc, quote = F, row.names = F, col.names = T)

# visualization for all simulations
tiff(filename=fn_hmmfig, units="px", width=2880, height=1800)
print(ggplot(dfviz, aes(y=as.numeric(accuracy), x=set, ymin=0, ymax=100)) + 
        geom_jitter(shape=16, width = 0.1, height = 0, aes(colour=r), size=5) +
        scale_colour_manual(values = pcolors) +
        ggtitle("Accuracy of MAST-HMM in Simulated Dataset") + 
        xlab("Topology Set") +
        ylab("Accuracy (%)") +
        theme(
          plot.title = element_text(hjust = 0.5, size = 50),
          axis.title.x=element_text(size = 40, margin = margin(t=20, r=0, b=0, l=0)),
          axis.title.y=element_text(size = 40, margin = margin(t=0, r=20, b=0, l=0)),
          axis.text.y=element_text(size=30),
          axis.text.x=element_text(size=30),
          legend.title=element_blank(),
          legend.text=element_text(size=30),
          legend.key.size=unit(2,"cm")
        ))
dev.off()

# visualization for simulations per recombination rate
fn_figs <- c(fn_figs, fn_hmmfig)
iterator <- 0

for (i in unique(dfviz$r)) {
  outperr <- subset(dfviz, dfviz$r == i)
  
  fn_hmmfig <- paste(params$outdir, "/", params$prefix, ".hmmacc.r",i,".tiff", sep="")
  fn_figs <- c(fn_figs, fn_hmmfig)
  iterator <- iterator + 1
  
  tiff(filename=fn_hmmfig, units="px", width=2880, height=1800)
  print(ggplot(outperr, aes(y=as.numeric(accuracy), x=set, ymin=0, ymax=100)) + 
          geom_boxplot() +
          geom_jitter(shape=16, width = 0.1, height = 0, aes(colour=r), size=5) +
          scale_colour_manual(values = pcolors[iterator]) +
          ggtitle("Accuracy of Non-Overlapping Windows in Simulated Dataset") + 
          xlab("Topology Set") +
          ylab("Accuracy (%)") +
          theme(
            plot.title = element_text(hjust = 0.5, size = 50),
            plot.margin = margin(1.25, 0, 1.25, 0, "cm"),
            axis.title.x=element_text(size = 40, margin = margin(t=20, r=0, b=0, l=0)),
            axis.title.y=element_text(size = 40, margin = margin(t=0, r=20, b=0, l=0)),
            axis.text.y=element_text(size=30),
            axis.text.x=element_text(size=30),
            legend.title=element_text(size=30),
            legend.text=element_text(size=30),
            legend.key.size=unit(2,"cm")
          ))
  dev.off()
}
```

```{r, fig.width=1, echo=FALSE}
knitr::include_graphics(fn_figs)
```