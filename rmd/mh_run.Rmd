---
title: "MAST-HMM Analysis"
---

```{r mhsetup, include=FALSE}
write.table(c("",
              "####################################",
              "####          MAST-HMM          ####",
              "####################################"),
            file=fn_log, quote=F, row.names=F, col.names=F, append=T)

mast_outdir <- paste(getwd(), "/masthmm/", sep="")
if (!file.exists(mast_outdir)) {
  dir.create(mast_outdir, recursive = T)
}

mast_model <- paste("'", params$mast_model, "'", sep="")

window_outdir <- paste(getwd(), "/windows/", sep="")
window_sizes <- list.dirs(window_outdir, full.names = F, recursive = F)

fn_topset <- paste(mast_outdir, params$prefix, ".topset", sep="")
fn_alisim <- paste(getwd(), "/simulation/", params$prefix, ".fa", sep="")
```

```{r premh, include=FALSE}
uq_tops <- data.frame()

if (file.exists(fn_topset) && params$redo == FALSE){
  uq_tops <- read.table(fn_topset)
  colnames(uq_tops) <- uq_tops[1,]
  uq_tops <- uq_tops[-1,]
  
  log4r::info(fn_logger, "File already exists: MAST-HMM topology sets. Skipped.")
  
} else {
  list_tops <- c("wsize","topologies")

  # extract top % topologies for each window size
  for (i in window_sizes) {
    topsum <- read.table(paste(window_outdir, i, "/summary/", params$prefix, ".topsum", sep=""))
    colnames(topsum) <- topsum[1,]
    topsum <- topsum[-1,]
    
    tpercent <- 0
    tmast <- c()
    for (j in 1:nrow(topsum)) {
      tmast <- c(tmast, topsum$newick[j])
      tpercent <- topsum$cum.percentage[j]
      
      if (tpercent >= params$mast_tops) {
        break
      }
    }
    
    list_tops <- rbind(list_tops, c(i,paste(sort(tmast),collapse="&")))
  }
  
  list_tops <- as.data.frame(list_tops)
  colnames(list_tops) <- list_tops[1,]
  list_tops <- list_tops[-1,]
  
  # extract unique set of topologies
  uq_tops <- list_tops %>%
    group_by(topologies) %>% 
    summarise(wsizes = paste(wsize, collapse = "_"))
  
  write.table(uq_tops, file=fn_topset, quote=F, row.names=F, col.names=T)
  log4r::info(fn_logger, paste("File created: MAST-HMM topology sets (",
                               params$prefix, ".topset).", sep=""))
}
```

```{r masthmm}
log4r::info(fn_logger, paste(nrow(uq_tops), "topology sets found."))

# iterate through topology sets
for (k in 1:nrow(uq_tops)) {
  topls <- strsplit(uq_tops$topologies[k],split = "&")[[1]]
  if (length(topls) <= 1) {
    log4r::info(fn_logger, paste(gsub("_",", ",uq_tops$wsizes[k]), "bp [set ", k, "] has one or less topology. Skipped.", sep=""))
    next
  }
  
  setfn <- paste(mast_outdir,k,"/",sep="")
  if (!file.exists(setfn)) {
    dir.create(setfn, recursive = T)
  }
  
  # save the topologies in separate file
  fn_mast_tops <- paste(setfn, params$prefix, ".mast.tops", sep="")
  if (!file.exists(fn_mast_tops) || params$redo == TRUE) {
    write.table(topls, file = fn_mast_tops, quote = F, row.names = F, col.names = F)
  }
  
  # create new directory based on the MAST model
  outdir <- paste(setfn, gsub('^\\_+|\\_+$','', tolower(gsub("[[:punct:]]","_",mast_model))), "/", sep="")
  if (!file.exists(outdir)) {
    dir.create(outdir, recursive = T)
  }
  
  prefix <- paste(outdir, params$prefix, sep="")
  if (file.exists(paste(prefix,".hmm",sep="")) && params$redo == FALSE) {
    log4r::info(fn_logger, paste("File exists: ", gsub("_",", ",uq_tops$wsizes[k]), "bp HMM file [set ", k, "]. Skipped.", sep=""))
    next
  }
  
  # run MAST-HMM
  log4r::info(fn_logger, paste("Run MAST-HMM [set ", k, "].", sep=""))
  mast_cl <- paste(params$iqtree2dir,"-s",fn_alisim,"-m",mast_model,"-blmin 0.0001 -te",fn_mast_tops,"-pre",prefix,"-hmm -wslm -wspm -alninfo -redo")
  system(mast_cl)
  log4r::info(fn_logger, paste("File created: HMM file [set ", k, "].", sep=""))
}
```