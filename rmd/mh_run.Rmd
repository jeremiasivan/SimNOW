---
title: "HMMSTER Analysis"
---

```{r mhsetup, include=FALSE}
if (params$analysis_type == HMMSTER) {
  write.table(c("",
                "####################################",
                "####           HMMSTER          ####",
                "####################################"),
              file=fn_log, quote=F, row.names=F, col.names=F, append=T)
}

# set up MAST output directory
mast_outdir <- paste0(getwd(), "/", tolower(params$analysis_type), "/")
if (!dir.exists(mast_outdir)) {
  dir.create(mast_outdir, recursive = T)
}

# add single quote for MAST model
mast_model <- paste0("'", params$mast_model, "'")

# extract window sizes
window_outdir <- paste0(getwd(), "/windows/")
window_sizes <- list.dirs(window_outdir, full.names = F, recursive = F)

# input / output files
fn_alisim <- paste0(getwd(), "/simulation/", params$prefix, ".fa")
fn_topset <- paste0(mast_outdir, params$prefix, ".topset")
```

```{r premh, include=FALSE}
uq_tops <- data.table::data.table()

# load the topology set if file exists
if (file.exists(fn_topset) && !params$redo){
  uq_tops <- data.table::fread(fn_topset)
  log4r::info(fn_logger, paste0("File found: ", params$analysis_type, " topology sets."))
  
} else {
  list_tops <- c()

  # extract top % topologies for each window size
  for (i in window_sizes) {
    topsum <- data.table::fread(paste0(window_outdir, i, "/summary/", params$prefix, ".topsum"))
    
    tpercent <- 0
    tmast <- c()
    for (j in 1:nrow(topsum)) {
      tmast <- c(tmast, topsum$newick[j])
      tpercent <- topsum$cum.percentage[j]
      
      if (tpercent >= params$mast_tops) {
        break
      }
    }
    
    list_tops <- rbind(list_tops, c(i,paste(sort(tmast),collapse="&")))
    rm(topsum)
  }
  
  list_tops <- data.table::as.data.table(list_tops)
  colnames(list_tops) <- c("wsize","topologies")
  
  # extract unique set of topologies
  uq_tops <- list_tops %>%
    group_by(topologies) %>% 
    summarise(wsizes = paste(wsize, collapse = "_"))
  
  data.table::fwrite(uq_tops, file=fn_topset, quote=F, sep="\t")
  log4r::info(fn_logger, paste0("File created: ", params$analysis_type, " topology sets (", params$prefix, ".topset)."))
  
  rm(list_tops)
}
```

```{r mh, include=FALSE}
log4r::info(fn_logger, paste0(nrow(uq_tops), " topology sets found."))

# iterate through topology sets
for (k in 1:nrow(uq_tops)) {
  setfn <- paste0(mast_outdir,k,"/")
  if (!dir.exists(setfn)) {
    dir.create(setfn, recursive = T)
  }
  
  # check number of topology
  topls <- strsplit(uq_tops$topologies[k],split = "&")[[1]]
  if (length(topls) <= 1) {
    log4r::info(fn_logger, paste0(gsub("_",", ",uq_tops$wsizes[k]), "bp [set ", k, "] has one or less topology. Skipped."))
    next
  }
  
  # create new directory based on the MAST model
  outdir <- paste0(setfn, gsub('^\\_+|\\_+$','', tolower(gsub("[[:punct:]]","_",mast_model))), "/")
  if (!dir.exists(outdir)) {
    dir.create(outdir, recursive = T)
  }
  
  # skip this step if HMM file exists
  prefix <- paste0(outdir, params$prefix)
  if (file.exists(paste0(prefix,".hmm")) && !params$redo) {
    log4r::info(fn_logger, paste0("File found: ", gsub("_",", ",uq_tops$wsizes[k]), "bp HMM file [set ", k, "]."))
    next
  }
  
  # save the topologies in separate file
  fn_mast_tops <- paste0(setfn, params$prefix, ".mast.tops")
  if (!file.exists(fn_mast_tops) || params$redo) {
    write.table(topls, file = fn_mast_tops, quote = F, row.names = F, col.names = F)
  }
  
  # run HMMSTER
  mast_cl <- ""
  log4r::info(fn_logger, paste0("Run ", params$analysis_type, " [set ", k, "]."))
  if (params$analysis_type == HMMSTER) {
    mast_cl <- paste(params$iqtree2dir,
                     "-s",fn_alisim,
                     "-m",mast_model,
                     "-blmin 0.0001",
                     "-te",fn_mast_tops,
                     "-pre",prefix,
                     "-hmmster -redo")
  }
  
  system(mast_cl)
}

rm(uq_tops)
```