---
title: "MAST Analysis"
---

```{r mhsetup, include=FALSE}
if (mast_analysis == MAST) {
  write.table(c("",
                "####################################",
                "####            MAST            ####",
                "####################################"),
              file=fn_log, quote=F, row.names=F, col.names=F, append=T)
} else if (mast_analysis == HiMAST) {
  write.table(c("",
                "####################################",
                "####           HiMAST           ####",
                "####################################"),
              file=fn_log, quote=F, row.names=F, col.names=F, append=T)
}

# set up MAST output directory
mast_outdir <- paste0(getwd(), "/", mast_analysis, "/", fn_mast_model, "/")

# set up per-window MAST output directory
mast_nw_outdir <- paste0(mast_outdir, "windows/")
if (!dir.exists(mast_nw_outdir)) {
  dir.create(mast_nw_outdir)
}

# set up ms-based MAST output directory
mast_ms_outdir <- paste0(mast_outdir, "ms/")
if (!dir.exists(mast_ms_outdir)) {
  dir.create(mast_ms_outdir)
}

# add single quote for MAST model
mast_model <- paste0("'", params$mast_model, "'")
ic_type <- tolower(params$ic_type)

# input files
fn_alisim <- paste0(getwd(), "/simulation/", params$prefix, ".fa")
fn_uqtops <- paste0(getwd(), "/simulation/", params$prefix, ".uqtops")
fn_summary <- paste0(getwd(), "/windows/", params$prefix, ".sum")

# output files
fn_mast_tops <- paste0(getwd(), "/", mast_analysis, "/", params$prefix, ".mast.tops")
fn_treefile <- paste0(mast_outdir, params$prefix, ".treefile")
```

```{r premh, include=FALSE}
options(scipen=999)

# read summary file
sum <- data.table::fread(fn_summary)
if (!ic_type %in% colnames(sum)) {
  errmsg <- "Error: invalid information criterion type. Exited."
  
  log4r::error(fn_logger, errmsg)
  stop(errmsg)
}

# select window size according to the lowest IC
wsize <- sum %>%
  slice_min(!!as.name(ic_type)) %>%
  select(window_size)
  
# skip this step if MAST input topology file is found
if (file.exists(fn_mast_tops) && !params$redo) {
  log4r::info(fn_logger, paste("File found:", toupper(mast_analysis), "topology file. Skipped."))
  
} else {
  # read topology file
  fn_topsum <- paste0(getwd(), "/windows/", wsize$window_size[1], "/summary/", params$prefix, ".topsum")
  topsum <- data.table::fread(fn_topsum)
  
  if (nrow(topsum) <= 1) {
    errmsg <- "Error: only one topology found. Exited."
    
    log4r::error(fn_logger, errmsg)
    stop(errmsg)
  }
  
  # extract topology according to threshold
  sub_topsum <- topsum %>%
    filter(cum.percentage < params$percent_tops)
  
  n <- nrow(sub_topsum)
  sub_topsum <- topsum[, .SD[0:n+1]] %>%
    select(topology)
  
  n <- nrow(sub_topsum)
  if (n <= 1 || n > params$max_tops) {
    errmsg <- paste0("Error: invalid number of topology (", n, "). Exited.")
    
    log4r::error(fn_logger, errmsg)
    stop(errmsg)
  }
  
  write.table(unlist(sub_topsum$topology), fn_mast_tops, col.names = F, quote = F, row.names = F)
  log4r::info(fn_logger, paste0("File created: ", toupper(mast_analysis), " topology file based on ", toupper(params$ic_type), "."))
}
```

```{r mh, include=FALSE}
if (file.exists(fn_treefile) && !params$redo) {
  log4r::info(fn_logger, paste("File found:", toupper(mast_analysis), "treefile. Skipped."))
  
} else {
  prefix <- paste0(mast_outdir, params$prefix)
  
  mast_cl <- paste(params$iqtree2dir,
                   "-s",fn_alisim,
                   "-m",mast_model,
                   "-te",fn_mast_tops,
                   "-pre",prefix,
                   "-T 1 -redo")
  
  # add HMM flag
  if (mast_analysis == HiMAST) {
    mast_cl <- paste(mast_cl, "-hmmster{gm}")
  }
  
  # run MAST
  system(mast_cl)
  log4r::info(fn_logger, paste("File created:", toupper(mast_analysis), "run."))
}
```

```{r hmmnow, include=FALSE}
if (mast_analysis == HiMAST) {
  options(scipen=999)
    
  fn_fasta_dir <- paste0(getwd(), "/windows/", wsize$window_size[1], "/alignment/")
  fn_fasta <- unlist(strsplit(list.files(fn_fasta_dir), ".fa"))
  
  # create doSNOW cluster
  nwcl <- makeCluster(params$thread)
  doSNOW::registerDoSNOW(nwcl)
  
  # run HiMAST for each window
  foreach (i = fn_fasta) %dopar% {
    temp_outdir <- paste0(mast_nw_outdir, i, "/")
    if (!dir.exists(temp_outdir)) {
      dir.create(temp_outdir)
    }
    
    # check if HMM file already exists
    temp_prefix <- paste0(temp_outdir, i)
    if (file.exists(paste0(temp_prefix, ".hmm"))){
      return(NULL)
    }
    
    # run HiMAST
    temp_fasta <- paste0(fn_fasta_dir, i, ".fa")
    mast_cl <- paste(params$iqtree2dir,
                   "-s",temp_fasta,
                   "-m",mast_model,
                   "-te",fn_mast_tops,
                   "-pre",temp_prefix,
                   "-hmmster -T 1 -redo")
    system(mast_cl)
    return(NULL)
  }
  
  stopCluster(nwcl)
  log4r::info(fn_logger, "File created/modified: window-based HiMAST runs.")
}
```

```{r hmmms, include=FALSE}
if (mast_analysis == HiMAST) {
  options(scipen=999)
  
  # check the number of input topologies
  n <- length(readLines(fn_uqtops))
  
  # prefix for HiMAST run
  temp_prefix <- paste0(mast_ms_outdir, params$prefix)
  
  # check if all criteria are met
  if (file.exists(paste0(temp_prefix, ".hmm"))){
    log4r::warn(fn_logger, paste0("File found: ms-based HMM file. Skipped."))
    
  } else if (n <= 1 || n > params$max_tops) {
    log4r::error(fn_logger, paste0("Error: invalid number of topology for ms-based HiMAST (", n, "). Skipped."))
    
  } else {
    # run HiMAST
    mast_cl <- paste(params$iqtree2dir,
                     "-s",fn_alisim,
                     "-m",mast_model,
                     "-te",fn_uqtops,
                     "-pre",temp_prefix,
                     "-hmmster{gm} -T 1 -redo")
    system(mast_cl)
    log4r::info(fn_logger, "File created: ms-based HiMAST run.")
  }
}
```