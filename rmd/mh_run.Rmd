---
title: "MAST Analysis"
---

```{r mhsetup, include=FALSE}
if (mast_analysis == MAST) {
  write.table(c("",
                "####################################",
                "####            MAST            ####",
                "####################################"),
              file=fn_log, quote=F, row.names=F, col.names=F, append=T)
} else if (mast_analysis == HiMAST) {
  write.table(c("",
                "####################################",
                "####           HiMAST           ####",
                "####################################"),
              file=fn_log, quote=F, row.names=F, col.names=F, append=T)
}

# set up MAST output directory
mast_outdir <- paste0(getwd(), "/", mast_analysis, "/", fn_mast_model, "/")

# add single quote for MAST model
mast_model <- paste0("'", params$mast_model, "'")
ic_type <- tolower(params$ic_type)

# input files
fn_alisim <- paste0(getwd(), "/simulation/", params$prefix, ".fa")
fn_summary <- paste0(getwd(), "/windows/", params$prefix, ".sum")

fn_mast_tops <- paste0(getwd(), "/", mast_analysis, "/", params$prefix, ".mast.tops")
fn_treefile <- paste0(mast_outdir, params$prefix, ".treefile")
```

```{r premh, include=FALSE}
if (file.exists(fn_mast_tops) && !params$redo) {
  log4r::info(fn_logger, paste("File found:", toupper(mast_analysis), "topology file. Skipped."))
  
} else {
  options(scipen=999)
  
  # read summary file
  sum <- data.table::fread(fn_summary)
  if (!ic_type %in% colnames(sum)) {
    log4r::error(fn_logger, paste("Error: invalid information criterion type. Exited."))
    knitr::knit_exit()
  }

  wsize <- sum %>%
    slice_min(!!as.name(ic_type)) %>%
    select(window_size)
  
  # read topology file
  fn_topsum <- paste0(getwd(), "/windows/", wsize$window_size[1], "/summary/", params$prefix, ".topsum")
  topsum <- data.table::fread(fn_topsum)
  
  if (nrow(topsum) == 1) {
    log4r::error(fn_logger, paste("Error: only one topology found. Exited."))
    knitr::knit_exit()
  }
  
  # extract topology according to threshold
  sub_topsum <- topsum %>%
    filter(cum.percentage < params$percent_tops)
  
  n <- nrow(sub_topsum)
  sub_topsum <- topsum[, .SD[0:n+1]] %>%
    select(topology)
  
  n <- nrow(sub_topsum)
  if (n == 1 || n > params$max_tops) {
    log4r::error(fn_logger, paste0("Error: invalid number of topology (", n, "). Exited."))
    knitr::knit_exit()
  }
  
  write.table(unlist(sub_topsum$topology), fn_mast_tops, col.names = F, quote = F, row.names = F)
  log4r::info(fn_logger, paste("File created:", toupper(mast_analysis), "topology file."))
}
```

```{r mh, include=FALSE}
if (file.exists(fn_treefile) && !params$redo) {
  log4r::info(fn_logger, paste("File found:", toupper(mast_analysis), "treefile. Skipped."))
  
} else {
  prefix <- paste0(mast_outdir, params$prefix)
  
  mast_cl <- paste(params$iqtree2dir,
                   "-s",fn_alisim,
                   "-m",mast_model,
                   "-te",fn_mast_tops,
                   "-pre",prefix,
                   "-T 1 -redo")
  
  # run MAST
  if (mast_analysis == HiMAST) {
    mast_cl <- paste(mast_cl, "-hmmster")
  }
  
  system(mast_cl)
}
```