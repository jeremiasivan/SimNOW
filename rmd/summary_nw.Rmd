---
title: "Summary of Multiple Non-overlapping Windows Analyses"
params:
  prefix: "db"
  outdir: "~/Documents/simulation/debug"
---

```{r setup, include=FALSE}
library(data.table)
library(dplyr)
library(ggplot2)

simsumdir <- paste0(params$outdir, "/simsum/")
if (!dir.exists(simsumdir)) {
  dir.create(simsumdir, recursive = T)
}
```

```{r simsum, include=FALSE}
fn_simsum <- paste0(simsumdir, params$prefix, ".simsum")
fn_simfig <- paste0(simsumdir, params$prefix, ".simsum.tiff")
fn_simifc <- paste0(simsumdir, params$prefix, ".simifc")
fn_difacc <- paste0(simsumdir, params$prefix, ".difacc")

# extract row and column names
allsims <- list.dirs(params$outdir, full.names = F, recursive = F)
simulation <- allsims[grep(paste0("^",params$prefix), allsims)]
simulation <- simulation[simulation != "simsum"]
simulation_ln <- length(simulation)

window_sizes <- list.dirs(paste0(params$outdir,"/",simulation[1],"/windows/"), full.names = F, recursive = F)
window_sizes <- window_sizes[window_sizes != paste0(simulation[1],".summary")]
window_sizes_ln <- length(window_sizes)

# extract summary for each simulation
output <- data.table::data.table(simulation, matrix(0, nrow=simulation_ln, ncol=window_sizes_ln+1))
data.table::setnames(output, c("simulation", window_sizes, "r"))

cnnames <- NULL
infocr <- data.table::data.table()
infodf <- data.table::data.table()

for (i in simulation) {
  # read simulation summary file
  row_idx <- match(i, output$simulation)
  sumfile <- data.table::fread(paste0(params$outdir,"/",i,"/windows/",i,".sum"))
  if (is.null(cnnames)){
    cnnames <- colnames(sumfile)[3:ncol(sumfile)]
  }
  
  for (j in 1:nrow(sumfile)) {
    output[row_idx, as.character(eval(sumfile$window_size[j])) := sumfile$accuracy[j]]
  }
  
  # calculate difference in accuracy
  dif_acc <- c()
  max_acc <- sumfile[match(max(sumfile$accuracy),sumfile$accuracy),accuracy]
  for (j in 3:ncol(sumfile)) {
    cnname <- colnames(sumfile)[j]
    min_ic <- sumfile[match(min(sumfile[,..cnname]), unlist(sumfile[,..cnname])), accuracy]
    dif_acc <- c(dif_acc, max_acc-min_ic)
  }
  infodf <- data.table::rbindlist(list(infodf, as.list(dif_acc)))
  
  # read ms file
  fn_ms <- paste0(params$outdir,"/",i,"/simulation/",i,".ms")
  command <- strsplit(system(paste("grep 'ms'",fn_ms), intern=T), " ")
  rrate <- as.numeric(command[[1]][match("-r", command[[1]]) + 1])
  
  # extract recombination rate
  output[row_idx, "r" := rrate]
  
  sumfile <- data.table::data.table("simulation" = rep(i, nrow(sumfile)), sumfile)
  sumfile[, "r" := rrate]
  infocr <- rbind(infocr, sumfile)
}

# update column names
data.table::setnames(infodf, cnnames)

data.table::fwrite(output, file=fn_simsum, quote = F, sep = "\t")
data.table::fwrite(infocr, file=fn_simifc, quote = F, sep = "\t")
data.table::fwrite(infodf[, lapply(.SD, mean)], file=fn_difacc, quote = F, sep = "\t")

# visualization
sub_output <- data.frame()
pcolors <- RColorBrewer::brewer.pal(8, "Dark2")
  
for (i in 1:nrow(output)) {
  for (j in 3:ncol(output)-1) {
    sub_output <- rbind(sub_output, c(output$simulation[i], colnames(output)[j], as.character(output[i, ..j]), as.numeric(output[i, "r"])))
  }
}
colnames(sub_output) <- c("simulation","wsize","accuracy","r")
sub_output$wsize <- factor(as.numeric(sub_output$wsize)/1000)

# visualization for all simulations
tiff(filename=fn_simfig, units="px", width=2880, height=1800)
print(ggplot(sub_output, aes(y=as.numeric(accuracy), x=wsize, ymin=0, ymax=100)) + 
        geom_jitter(shape=16, width = 0.1, height = 0, aes(colour=r), size=5) +
        scale_colour_manual(values = pcolors) +
        ggtitle("Accuracy of Non-Overlapping Windows in Simulated Dataset") + 
        xlab("Window size (kb)") +
        ylab("Accuracy (%)") +
        theme(
          plot.title = element_text(hjust = 0.5, size = 50),
          plot.margin = margin(0, 0, 1.25, 0, "cm"),
          axis.title.x=element_text(size = 40, margin = margin(t=20, r=0, b=0, l=0)),
          axis.title.y=element_text(size = 40, margin = margin(t=0, r=20, b=0, l=0)),
          axis.text.y=element_text(size=30),
          axis.text.x=element_text(size=30),
          legend.title=element_text(size=30),
          legend.text=element_text(size=30),
          legend.key.size=unit(2,"cm")
        ))
dev.off()

# visualization for simulations per recombination rate
fn_figs <- c(fn_simfig)
iterator <- 0
for (i in unique(sub_output$r)) {
  fn_simfig <- paste0(simsumdir, params$prefix, ".simsum.r",i,".tiff")
  fn_figs <- c(fn_figs, fn_simfig)
  outperr <- subset(sub_output, sub_output$r == i)
  iterator <- iterator + 1
  
  tiff(filename=fn_simfig, units="px", width=2880, height=1800)
  print(ggplot(outperr, aes(y=as.numeric(accuracy), x=wsize, ymin=0, ymax=100)) + 
          geom_boxplot(outlier.shape = NA) +
          geom_jitter(shape=16, width = 0.1, height = 0, aes(colour=r), size=5) +
          scale_colour_manual(values = pcolors[iterator]) +
          ggtitle("Accuracy of Non-Overlapping Windows in Simulated Dataset") + 
          xlab("Window size (kb)") +
          ylab("Accuracy (%)") +
          theme(
            plot.title = element_text(hjust = 0.5, size = 50),
            plot.margin = margin(1.25, 0, 1.25, 0, "cm"),
            axis.title.x=element_text(size = 40, margin = margin(t=20, r=0, b=0, l=0)),
            axis.title.y=element_text(size = 40, margin = margin(t=0, r=20, b=0, l=0)),
            axis.text.y=element_text(size=30),
            axis.text.x=element_text(size=30),
            legend.title=element_text(size=30),
            legend.text=element_text(size=30),
            legend.key.size=unit(2,"cm")
          ))
  dev.off()
}

# visualization for information criteria
infocr$accuracy <- as.numeric(infocr$accuracy)
infocr$window_size <- as.character(infocr$window_size/1000)

for (i in 5:ncol(infocr)-1) {
  ifc <- colnames(infocr)[i]
  fn_simfig <- paste0(simsumdir, params$prefix, ".simifc.",ifc,".tiff")
  
  tiff(filename=fn_simfig, units="px", width=2880, height=1800)
  print(ggplot(infocr, aes(y=accuracy, x=as.numeric(unlist(infocr[,..i])), ymin=0, ymax=100, color=simulation)) +
          geom_jitter(aes(shape=forcats::fct_inseq(window_size)), width = 0, height = 0, size=5) +
          geom_smooth(method = "lm", fill = NA) +
          scale_shape_manual(values = 1:length(unique(infocr$window_size))) +
          ggtitle(paste("Correlation between", toupper(ifc), "and Accuracy")) + xlab(toupper(ifc)) + ylab("Accuracy (%)") +
          labs(shape="wsize (kb)") +
          guides(color="none") +
          theme(
            plot.title = element_text(hjust = 0.5, size = 50),
            plot.margin = margin(1.25, 0, 1.25, 0, "cm"),
            axis.title.x=element_text(size = 40, margin = margin(t=20, r=0, b=0, l=0)),
            axis.title.y=element_text(size = 40, margin = margin(t=0, r=20, b=0, l=0)),
            axis.text.y=element_text(size=30),
            axis.text.x=element_text(size=30),
            legend.title=element_text(size=30),
            legend.text=element_text(size=30),
            legend.key.size=unit(2,"cm")
          ))
  dev.off()
}
```

<br>

```{r, fig.width=1, echo=FALSE, eval=FALSE}
knitr::include_graphics(fn_figs)
```
