---
title: "Summary of MAST-HMM and HMMSTER Analysis vs Truth"
---

```{r sumsetup, include=FALSE}
if (params$analysis_type == MASTHMM) {
  write.table(c("",
                "####################################",
                "####      MAST-HMM vs Truth     ####",
                "####################################"),
              file=fn_log, quote=F, row.names=F, col.names=F, append=T)
  
} else if (params$analysis_type == HMMSTER) {
  write.table(c("",
                "####################################",
                "####      HMMSTER vs Truth      ####",
                "####################################"),
              file=fn_log, quote=F, row.names=F, col.names=F, append=T)
}

mast_outdir <- paste(getwd(), "/", tolower(params$analysis_type), "/", sep="")
mast_model <- paste("'", params$mast_model, "'", sep="")
mast_dirs <- list.dirs(mast_outdir, full.names = F, recursive = F)

fn_mstops <- paste(getwd(), "/simulation/", params$prefix, ".mstops", sep="")
fn_topset <- paste(mast_outdir, params$prefix, ".topset", sep="")
fn_summary <- paste(mast_outdir, params$prefix, ".mh.sum", sep="")
```

```{r postmh, include=FALSE}
# read input files
msfile <- read.table(fn_mstops)
colnames(msfile) <- msfile[1,]
msfile <- msfile[-1,]

options(scipen=999)

# iterate through topology sets
for (i in mast_dirs) {
  temp_outdir <- paste(mast_outdir,i,"/",sep="")
  outdir <- paste(temp_outdir, gsub('^\\_+|\\_+$','', tolower(gsub("[[:punct:]]","_",mast_model))), "/", sep="")
 
  fn_hmmtw <- paste(outdir, params$prefix, ".hmmtw", sep="")
  fn_hmmsum <- paste(outdir, params$prefix, ".hmmsum", sep="")
  # fn_hmmfig <- paste(outdir, params$prefix, ".hmmsum.tiff", sep="")
  if (all(file.exists(fn_hmmtw, fn_hmmsum)) && params$redo == FALSE) {
    log4r::info(fn_logger, paste0("Files exist: ",params$analysis_type," summary files for set ", i, ". Skipped."))
    next
  }
  
  # read HMM file
  fn_hmm <- paste(outdir, params$prefix, ".hmm", sep="")
  if (!file.exists(fn_hmm)) {
    log4r::warn(fn_logger, paste0("Warn: HMM file for set ", i, " is not found. Skipped."))
    next
  }
  
  hmmfile <- readLines(fn_hmm)
  hmmtrees <- subset(hmmfile, grepl("^\\[", hmmfile))
  
  fn_mast_tops <- paste(temp_outdir, params$prefix, ".mast.tops", sep="")
  tmfile <- readLines(fn_mast_tops)
  unique_topologies <- unique(tmfile)
  
  # match window topology with ms topology
  for (j in 1:nrow(msfile)) {
    for (k in unique_topologies) {
      if (all.equal.phylo(unroot(read.tree(text = msfile$topology[j])), read.tree(text = k))) {
        msfile$topology[j] <- k
        break
      }
    }
  }
  
  # ms topology weights
  ms_tw <- msfile %>%
    summarise(topology = topology, ms=as.numeric(length)/sum(as.numeric(msfile$length))) %>%
    group_by(topology) %>%
    summarise_all(sum)
  
  # hmm topology weights
  htw <- c()
  hmm_tw <- gsub("^.*: ", "", system(paste("grep '^Ratio of sites for each category'",fn_hmm), intern = T))
  ls_hmm_tw <- strsplit(hmm_tw, " ")[[1]]
  
  # MAST-HMM or HMMSTER topology weights
  if (params$analysis_type == MASTHMM) {
    fn_mast <- paste(outdir, params$prefix, ".iqtree", sep="")
    mast_tw <- gsub("^.*: ", "", system(paste("grep '^Tree weights'",fn_mast), intern = T))
    ls_mast_tw <- strsplit(mast_tw, ", ")[[1]]
    
    # MAST topology weights comparison with ms topology
    mtw <- c()
    
    for (j in 1:nrow(ms_tw)) {
      top_idx <- match(ms_tw$topology[j], tmfile)
      mtw <- c(mtw, round(as.numeric(ls_mast_tw[top_idx]), 4))
      htw <- c(htw, round(as.numeric(ls_hmm_tw[top_idx]), 4))
    }
    
    ms_tw <- cbind(ms_tw, mast=mtw, hmm=htw)
    write.table(ms_tw, file=fn_hmmtw, quote = F, row.names = F)
  
  } else if (params$analysis_type == HMMSTER) {
    for (j in 1:nrow(ms_tw)) {
      top_idx <- match(ms_tw$topology[j], tmfile)
      htw <- c(htw, round(as.numeric(ls_hmm_tw[top_idx]), 4))
    }
    
    ms_tw <- cbind(ms_tw, hmm=htw)
    write.table(ms_tw, file=fn_hmmtw, quote = F, row.names = F)
  }
  
  # extract per-site topology
  trees <- data.frame(do.call('rbind', strsplit(as.character(hmmtrees),'\\[|,|\\]')))
  trees[,1] <- NULL
  colnames(trees) <- c("start","stop","tree")
  
  dat <- do.call(rbind, apply(trees, 1,
               function(x) data.table(bp = x["start"]:x["stop"], tree = x["tree"])))
  
  # create empty dataframe
  empty_matrix <- as.data.frame(matrix(rep(0, length(tmfile)+1), nrow=length(tmfile), ncol=length(tmfile)+1))
  names(empty_matrix) <- c(tmfile,"NT")
  
  output <- data.frame(topology = tmfile)
  output <- cbind(output, empty_matrix)
  
  # iterate through ms topology file
  for (k in 1:nrow(msfile)){
    sites <- dat[msfile$start[k]:msfile$stop[k],]
    topology_idx <- which(colnames(output)==msfile$topology[k])
    
    sites_sum <- sites %>%
      group_by(tree) %>%
      summarise(n=n())
    
    # add number of HMM sites for the respective ms topology
    for (j in 1:nrow(sites_sum)) {
      window_idx <- which(output$topology==tmfile[as.numeric(sites_sum$tree[j])])
      
      if (length(topology_idx) == 0) {
        output$NT[window_idx] = output$NT[window_idx] + sites_sum$n[j]
      } else {
        output[window_idx,topology_idx] = output[window_idx,topology_idx] + sites_sum$n[j]
      }
    }
    
    rm(sites, sites_sum)
  }
  
  # visualization
  # sub_output <- data.frame()
  # 
  # for (k in 1:nrow(output)) {
  #   for (j in 2:ncol(output)) {
  #     sub_output <- rbind(sub_output, c(output$topology[k],colnames(output[j]),output[k,j]))
  #   }
  # }
  # colnames(sub_output) <- c("topology","sites","frequency")
  # sub_output$sites <- factor(sub_output$sites,levels = unique(sub_output$sites),ordered = T)
  # 
  # tiff(filename=fn_hmmfig, units="px", width=2880, height=1800)
  # print(ggplot(sub_output, aes(fill=sites, y=as.numeric(frequency), x=topology)) + 
  #         geom_bar(position="dodge", stat="identity") +
  #         aes(x = fct_inorder(topology)) +
  #         ggtitle(paste("Distribution of Sites from", params$analysis_type, "in Simulated Dataset")) + 
  #         xlab("True topology from simulated data") +
  #         ylab(paste("Number of sites from", params$analysis_type)) +
  #         theme(
  #           plot.title = element_text(hjust = 0.5, size = 50),
  #           axis.title.x=element_text(size = 40, margin = margin(t=20, r=0, b=0, l=0)),
  #           axis.title.y=element_text(size = 40, margin = margin(t=0, r=20, b=0, l=0)),
  #           axis.text.y=element_text(size=30),
  #           axis.text.x=element_text(size=30),
  #           legend.title=element_blank(),
  #           legend.text=element_text(size=30),
  #           legend.key.size=unit(2,"cm")
  #         ))
  # dev.off()
  
  write.table(output, file=fn_hmmsum, quote = F, row.names = F)
  log4r::info(fn_logger, paste0("Files created: set ", i, " ", params$analysis_type, " summary files (",
                               params$prefix, ".hmmtw, ", params$prefix, ".hmmsum)."))
  
  rm(hmmfile, hmmtrees, tmfile, ms_tw, trees, dat, empty_matrix, output)
}

rm(msfile)
```

```{r sumtable, include=FALSE}
t_accuracy <- c("set","accuracy","aic","aicc","bic","hmm")

for (i in mast_dirs) {
  temp_outdir <- paste(mast_outdir,i,"/",sep="")
  outdir <- paste(temp_outdir, gsub('^\\_+|\\_+$','', tolower(gsub("[[:punct:]]","_",mast_model))), "/", sep="")
  
  fn_iqtree <- paste(outdir, params$prefix, ".iqtree", sep="")
  fn_hmm <- paste(outdir, params$prefix, ".hmm", sep="")
  
  fn_hmmsum <- paste(outdir, params$prefix, ".hmmsum", sep="")
  if (!file.exists(fn_hmmsum)) {
    log4r::warn(fn_logger, paste0("Warn: HMM summary file for set ", i, " is not found. Skipped."))
    next
  }
  
  hmmsum <- read.table(fn_hmmsum)
  hmmsum <- as.matrix(hmmsum[-1,-1])
    
  # calculate the accuracy with if conditional for one topology  
  acc <- sum(as.numeric(diag(hmmsum))) / sum(as.numeric(hmmsum)) * 100
  acc <- round(acc, 3)
  
  # extract information of interest
  aic <- gsub("^.* ", "", system(paste("grep '^Akaike information criterion'",fn_iqtree), intern = T))
  aicc <- gsub("^.* ", "", system(paste("grep '^Corrected Akaike information criterion'",fn_iqtree), intern = T))
  bic <- gsub("^.* ", "", system(paste("grep '^Bayesian information criterion'",fn_iqtree), intern = T))
  hmm <- gsub("^.* :", "", system(paste("grep '^BEST HMM SCORE'",fn_hmm), intern = T))
  
  t_accuracy <- rbind(t_accuracy, c(i,acc,aic,aicc,bic,hmm))
  
  rm(hmmsum, acc)
}

t_accuracy <- as.data.frame(t_accuracy)
colnames(t_accuracy) <- t_accuracy[1,]
t_accuracy <- t_accuracy[-1,]

write.table(t_accuracy, fn_summary, quote=F, row.names=F, col.names=T)
log4r::info(fn_logger, paste0("File created/modified: summary table of ", params$analysis_type, " and ms (", params$prefix, ".mh.sum)."))

# correlation plot
pcolors <- RColorBrewer::brewer.pal(8, "Dark2")
iterator <- 0

for (c in 3:ncol(t_accuracy)) {
  fn_sumfig <- paste(mast_outdir, params$prefix, ".", colnames(t_accuracy)[c],".mh.tiff", sep="")
  iterator <- iterator + 1
  
  tiff(filename=fn_sumfig, units="px", width=2880, height=1800)
  print(ggplot(t_accuracy, aes(y=as.numeric(accuracy), x=as.numeric(t_accuracy[,c]), ymin=0, ymax=100)) + 
          geom_jitter(shape=16, width = 0.2, height = 0.2, size=5) +
          scale_colour_manual(values = pcolors[iterator]) +
          ggtitle(paste("Correlation of", params$analysis_type, "Information Criterion and NOW Accuracy")) + 
          xlab("Information criterion score") +
          ylab("Accuracy (%)") +
          theme(
            plot.title = element_text(hjust = 0.5, size = 50),
            axis.title.x=element_text(size = 40, margin = margin(t=20, r=0, b=0, l=0)),
            axis.title.y=element_text(size = 40, margin = margin(t=0, r=20, b=0, l=0)),
            axis.text.y=element_text(size=30),
            axis.text.x=element_text(size=30),
            legend.title=element_blank(),
            legend.text=element_text(size=30),
            legend.key.size=unit(2,"cm")
          ))
  dev.off()
}

log4r::info(fn_logger, paste0("Files created/modified: NOW accuracy vs ", params$analysis_type, " IC correlation plots."))

rm(t_accuracy)
```