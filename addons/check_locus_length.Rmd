---
title: "Check Locus Length Distribution Across Simulations"
params:
  prefix: "sim"
  outdir: "~/simulation"
---

```{r setup, include=FALSE}
library(data.table)
library(ggplot2)
```

```{r ms, include=FALSE}
options(scipen = 999)

# extract simulations
allsims <- list.dirs(params$outdir, full.names = F, recursive = F)
simulation <- allsims[grep(paste0("^",params$prefix), allsims)]

locuslen <- c()

for (s in simulation) {
  fn_msfile <- paste0(params$outdir, "/", s, "/simulation/", s, ".ms")
  command <- strsplit(system(paste("grep 'ms'",fn_msfile), intern=T), " ")
  r_idx <- match("-r", command[[1]]) + 1
  
  # extract ms params
  rho <- command[[1]][r_idx]
  ms_l <- command[[1]][r_idx+1]
  
  # read msfile
  ms <- data.table::fread(fn_msfile, col.names="cmd", sep="")
  
  # extract ms trees
  mstrees <- ms[grepl("^\\[", cmd)]
  if (nrow(mstrees) == 0) {
    mstrees <- ms[grepl("^\\(.+\\);$", cmd)]
    mstrees[1, cmd := paste0("[", ms_l, "]", mstrees[1, cmd])]
  }
  
  # convert ms trees into data.table
  mstrees[, c("empty","length","tree") := data.table::tstrsplit(cmd, '\\[|\\]', fixed = FALSE)]
  locuslen[[rho]] <- c(locuslen[[rho]], unlist(as.numeric(mstrees$length)))
}

# write output file
fn_file <- paste0(params$outdir, "/", params$prefix, ".loclen")
write.table(data.frame(cbind("r","mean","sd")), file=fn_file, quote=F, row.names=F, col.names=F)

#visualization
for (r in names(locuslen)) {
  fn_fig <- paste0(params$outdir, "/", params$prefix, ".r", r, ".loclen.tiff")
  write.table(data.frame(cbind(r, round(mean(locuslen[[r]]),5), round(sd(locuslen[[r]]),5))),
            file=fn_file, quote=F, row.names=F, col.names=F, append=T)
  
  lenbin <- ceiling(sqrt(length(locuslen[[r]])))
  widthbin <- (max(locuslen[[r]]) - min(locuslen[[r]])) / lenbin
  if (widthbin == 0) {
    next
  }
  
  tiff(filename=fn_fig, units="px", width=2880, height=1800)
  print(ggplot(data.frame(length=locuslen[[r]]), aes(x=as.numeric(length))) +
    geom_histogram(binwidth=widthbin, alpha=.5, position="identity") +
    ggtitle(paste0("Distribution of locus length (bin width=", round(widthbin, 5), ")")) +
    xlab("Length (kb)") +
    ylab("Count") +
    theme(
        plot.title = element_text(hjust = 0.5, size = 50),
        plot.margin = margin(1.25, 1.25, 1.25, 0.25, "cm"),
        axis.title.x=element_text(size = 40, margin = margin(t=20, r=0, b=0, l=0)),
        axis.title.y=element_text(size = 40, margin = margin(t=0, r=20, b=0, l=0)),
        axis.text.y=element_text(size=30),
        axis.text.x=element_text(size=30),
        legend.position = "none"
      ))
  dev.off()
}
```