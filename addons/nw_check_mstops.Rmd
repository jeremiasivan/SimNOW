---
title: "Check Number of Loci and Topology Across Simulations"
params:
  # general
  prefix: "sim"
  outdir: "~/simulation"
  nreps: 50
  thread: 5
  
  top_threshold: 0.985
  
  # ms
  msdir: "~/msdir/ms"
  ms_params: ""
  ms_r: 0
  ms_l: 1000000
---

```{r setup, include=FALSE}
# install.packages("data.table")
# install.packages("dplyr")
library(doSNOW)

# create doSNOW cluster
nwcl <- makeCluster(params$thread)
doSNOW::registerDoSNOW(nwcl)
```

```{r ms, include=FALSE}
# run in parallelization
lenout <- foreach (i = 1:params$nreps, .combine=c) %dopar% {
  library(data.table)
  library(dplyr)
  
  options(scipen=999)
  prefix <- paste0(params$prefix, "_", i)
  
  # set working directory
  currentdir <- paste0(params$outdir, "/", prefix, "/")
  if (!dir.exists(currentdir)) {
    dir.create(currentdir, recursive = T)
  }
  
  # output files
  fn_msfile <- paste0(currentdir, prefix, ".ms")
  fn_mstops <- paste0(currentdir, prefix, ".mstops")
  
  # generate seedms
  randseed <- paste(sample(10000:99999,3), collapse=" ")
  ms_cmd <- paste(params$ms_params, "-r", params$ms_r, params$ms_l, "-seeds", randseed)
  
  # generate msfile
  system(paste(params$msdir,ms_cmd,">",fn_msfile))
  
  # read msfile
  ms <- data.table::fread(fn_msfile, col.names="cmd", sep="")
  
  # extract ms trees
  mstrees <- ms[grepl("^\\[", cmd)]
  if (nrow(mstrees) == 0) {
    mstrees <- ms[grepl("^\\(.+\\);$", cmd)]
    mstrees[1, cmd := paste0("[", params$ms_l, "]", mstrees[1, cmd])]
  }
  
  # convert ms trees into data.table
  mstrees[, c("empty","length","tree") := data.table::tstrsplit(cmd, '\\[|\\]', fixed = FALSE)]
  mstrees[, c("cmd", "empty") := NULL]
  mstrees$length <- as.numeric(mstrees$length)
  
  # group by tree
  summary <- mstrees %>%
    group_by(tree) %>%
    summarise(n=n())
  summary <- data.table::as.data.table(summary)
  
  # store trees without branch lengths
  n <- nrow(summary)
  topology <- c()

  for (i in 1:n){
    temp_tree <- ape::read.tree(text=summary$tree[i])
    temp_tree$edge.length <- NULL
    topology <- c(topology, ape::write.tree(temp_tree))
  }
  summary[, "rtopology" := topology]
  summary$tree <- NULL
  
  # match the naming convention of topologies
  uq_tops <- unique(summary$rtopology)
  ls_unroot <- NULL
  ls_uqtops <- NULL
  
  for (i in uq_tops) {
    is_equal <- FALSE
    
    for (j in ls_unroot) {
      if (ape::all.equal.phylo(ape::unroot(ape::read.tree(text = i)), ape::unroot(ape::read.tree(text = j)))) {
        is_equal <- TRUE
        ls_uqtops[[i]] <- j
        break
      }
    }
    
    if (!is_equal) {
      ls_unroot <- c(ls_unroot, i)
      ls_uqtops[[i]] <- i
    }
  }
  
  lookup <- match(summary$rtopology, names(ls_uqtops))
  summary[, "topology" := as.character(ls_uqtops[lookup])]
  summary$rtopology <- NULL
  
  # group by topology
  usummary <- summary %>%
    group_by(topology) %>%
    summarise(n = sum(n), percentage = round(n/sum(summary$n) * 100, 5)) %>%
    arrange(-n) %>%
    mutate(cum.percentage = round(cumsum(n) / sum(summary$n), 5))
  
  sub_sum <- head(subset(usummary$cum.percentage, usummary$cum.percentage >= params$top_threshold), 1)
  sum_idx <- match(sub_sum, usummary$cum.percentage)
  
  data.table::fwrite(usummary, file=fn_mstops, quote=FALSE, sep="\t")
  
  list(list(nrow(mstrees),sum_idx))
}

stopCluster(nwcl)

# output
lenloci <- sapply(lenout, function(x){x[[1]]})
lentree <- sapply(lenout, function(x){x[[2]]})

write.table(c(paste0("Average number of loci: ", mean(lenloci), " (", round(sd(lenloci),5), ")"),
              paste0("Average number of topologies: ", mean(lentree), " (", round(sd(lentree),5), ")")),
            file = paste0(params$outdir, "/", params$prefix, ".mssum"),
            quote = FALSE, row.names = FALSE, col.names = FALSE)
```
